task.wait(10)
getgenv().ScriptLoadString = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/uaualeieow/script/refs/heads/main/script"))()'
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local Workspace = game:GetService("Workspace")
local PathfindingService = game:GetService("PathfindingService")

repeat task.wait() until Players.LocalPlayer
local existingGuiName = "NewScriptGui"

pcall(function()
    for _, container in ipairs({CoreGui, Players.LocalPlayer and Players.LocalPlayer:WaitForChild("PlayerGui")}) do
        if container then
            local old = container:FindFirstChild(existingGuiName)
            if old then old:Destroy() end
            local old_overlay = container:FindFirstChild(existingGuiName .. "_Overlay")
            if old_overlay then old_overlay:Destroy() end
            local old_blur = Lighting:FindFirstChild(existingGuiName.."_UIBlur")
            if old_blur then old_blur:Destroy() end
        end
    end
end)

local function buildGui()
    local Theme = {
        Main = Color3.fromRGB(15, 15, 16),
        Card = Color3.fromRGB(22, 22, 24),
        AccentA = Color3.fromRGB(255, 60, 140),
        AccentB = Color3.fromRGB(180, 40, 255),
        Stroke = Color3.fromRGB(45, 45, 50),
        Text = Color3.fromRGB(240, 240, 240),
        Muted = Color3.fromRGB(160, 160, 170),
        Success = Color3.fromRGB(40, 220, 120),
        Danger = Color3.fromRGB(255, 80, 80),
        DefaultButton = Color3.fromRGB(35, 35, 38)
    }

local antiAFKConn
local function antiAFK()
    local lp = Players.LocalPlayer
    if lp then
        local gc = getconnections or get_signal_cons
        if gc then
            for _, v in pairs(gc(lp.Idled)) do
                if v["Disable"] then v["Disable"](v)
                elseif v["Disconnect"] then v["Disconnect"](v) end
            end
        else
            lp.Idled:Connect(function()
                local vu = game:GetService("VirtualUser")
                vu:CaptureController()
                vu:ClickButton2(Vector2.new())
            end)
        end
    end
end
task.spawn(antiAFK)

local function persist()
    local qot = queue_on_teleport or (syn and syn.queue_on_teleport) or (fluxus and fluxus.queue_on_teleport) or queue_teleport
    if qot then
        local code = getgenv().ScriptLoadString
        if type(code) ~= "string" then 
            code = 'loadstring(game:HttpGet("https://raw.githubusercontent.com/uaualeieow/script/refs/heads/main/script"))()' 
        end
        pcall(function() qot(code) end)
        pcall(function()
            Players.LocalPlayer.OnTeleport:Connect(function()
                pcall(function() qot(code) end)
            end)
        end)
    end
end
task.spawn(persist)



local unloaded = false
local config = {
    serverAutoRefresh = false,
    serverAutoJoin = false,
    serverPreference = "Luck",
    autoJoinFilters = {},
    serverFilters = {},
    autoBuyList = {},
    autoBuyActive = false,
    remoteSpyEnabled = false,
    uiScale = 1,
    islandAutoTeleport = false,
    shopWaypoint = nil
}

local function saveConfig()
    if not writefile then return end
    pcall(function()
        writefile(existingGuiName.."_config.json", HttpService:JSONEncode(config))
    end)
end

local function loadConfig()
    if not isfile or not readfile then return end
    local path = existingGuiName.."_config.json"
    if isfile(path) then
        pcall(function()
            local data = HttpService:JSONDecode(readfile(path))
            for k,v in pairs(data) do config[k] = v end
        end)
    end
end
loadConfig()

local function autoCloseErrors()
    task.spawn(function()
        local guiService = game:GetService("GuiService")
        while not unloaded do
            pcall(function()
                if guiService then guiService:ClearError() end
                
                local targets = {CoreGui:FindFirstChild("RobloxGui"), CoreGui:FindFirstChild("RobloxPromptGui")}
                for _, gui in ipairs(targets) do
                    if gui then
                        local prompt = gui:FindFirstChild("promptOverlay")
                        local err = (prompt and prompt:FindFirstChild("ErrorPrompt")) or gui:FindFirstChild("ErrorPrompt", true)
                        if err and err.Visible then err.Visible = false end
                        
                        for _, v in ipairs(gui:GetDescendants()) do
                            if v:IsA("TextLabel") and (v.Text:lower():find("teleport failed") or v.Text:lower():find("timed out")) then
                                local p = v.Parent
                                if p and p:IsA("Frame") then p.Visible = false end
                                if p and p.Parent and p.Parent:IsA("Frame") then p.Parent.Visible = false end
                            end
                        end
                    end
                end
            end)
            task.wait(2)
        end
    end)
end
autoCloseErrors()

local connections = {}
local function bind(conn) if conn then table.insert(connections, conn) end return conn end
local mainGui, overlayGui

local function disconnectAll()
    for _,c in ipairs(connections) do pcall(function() c:Disconnect() end) end
    connections = {}
end

local DropdownRegistry = {}
local function registerDropdown(api) table.insert(DropdownRegistry, api) end
local function closeAllDropdowns()
    for _, api in ipairs(DropdownRegistry) do
        pcall(function() if api.Close then api.Close(true) end end)
    end
end

local function unload()
    if unloaded then return end
    unloaded = true
    pcall(function() if antiAFKConn then antiAFKConn:Disconnect() end end)
    pcall(function() if mainGui and mainGui.Destroy then mainGui:Destroy() end end)
    pcall(function() if overlayGui and overlayGui.Destroy then overlayGui:Destroy() end end)
    disconnectAll()
    pcall(function()
        local blur = Lighting:FindFirstChild(existingGuiName.."_UIBlur")
        if blur and blur.Destroy then blur:Destroy() end
    end)
    pcall(function() if script and script.Destroy then script:Destroy() end end)
end

local function New(class, props, children)
    local o = Instance.new(class)
    for k,v in pairs(props or {}) do if k ~= "Parent" then o[k] = v end end
    if children then for _,c in ipairs(children) do c.Parent = o end end
    o.Parent = props and props.Parent or nil
    return o
end

local function ensureOverlay()
    if overlayGui and overlayGui.Parent then return overlayGui end
    overlayGui = CoreGui:FindFirstChild(existingGuiName .. "_Overlay")
    if not overlayGui then
        overlayGui = New("ScreenGui", {
            Name = existingGuiName .. "_Overlay",
            ResetOnSpawn = false,
            ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
            DisplayOrder = 999999,
            IgnoreGuiInset = true,
            Parent = CoreGui
        })
    end
    overlayGui.Enabled = true
    return overlayGui
end

local Theme = {
    Surface = Color3.fromRGB(10, 10, 10),
    Card    = Color3.fromRGB(15, 15, 15),
    Stroke  = Color3.fromRGB(40, 40, 40),
    Text    = Color3.fromRGB(240, 240, 240),
    Muted   = Color3.fromRGB(150, 150, 150),
    Success = Color3.fromRGB(30, 200, 120),
    Danger  = Color3.fromRGB(220, 60, 60),
    AccentA = Color3.fromRGB(95, 66, 255),
    AccentB = Color3.fromRGB(0, 195, 255),
    DefaultButton = Color3.fromRGB(25, 25, 25),
}
Theme.ActiveTab = Theme.AccentA:lerp(Theme.AccentB, 0.5)

local FX = {}
function FX.CreateOrGetBlur()
    local blur = Lighting:FindFirstChild(existingGuiName.."_UIBlur")
    if not blur then
        blur = Instance.new("BlurEffect")
        blur.Name = existingGuiName.."_UIBlur"
        blur.Size = 0
        blur.Parent = Lighting
    end
    return blur
end
function FX.TweenBlur(enable)
    local blur = FX.CreateOrGetBlur()
    local target = enable and 12 or 0
    TweenService:Create(blur, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Size = target }):Play()
end

local Components = {}
local UIState = setmetatable({}, {__mode="k"})

function Components.SetState(element, state, color)
    if not element or not element.Parent then return end
    UIState[element] = { state = state, color = color }
    pcall(function() TweenService:Create(element, TweenInfo.new(0.18), {BackgroundColor3 = color}):Play() end)
end

function Components.DropShadow(parent, radius)
    local shadow = New("ImageLabel", {
        BackgroundTransparency = 1,
        Image = "rbxassetid://1316045217",
        ImageColor3 = Color3.fromRGB(0,0,0),
        ImageTransparency = 0.8,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(10,10,118,118),
        Size = UDim2.new(1, 40, 1, 40),
        Position = UDim2.fromScale(0.5,0.5),
        AnchorPoint = Vector2.new(0.5,0.5),
        ZIndex = 0,
        Parent = parent,
        Name = "_Shadow"
    })
    if radius then New("UICorner", { CornerRadius = UDim.new(0, radius), Parent = shadow }) end
    return shadow
end

function Components.Card(props)
    local frame = New("Frame", {
        Size = props.Size or UDim2.new(0, 560, 0, 380),
        Position = props.Position or UDim2.fromScale(0.5, 0.5),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Theme.Card,
        BackgroundTransparency = 0,
        ClipsDescendants = true,
        Parent = props.Parent,
        Name = props.Name or "Card",
        ZIndex = props.ZIndex or 1,
    }, {
        New("UICorner", { CornerRadius = UDim.new(0, 16) }),
        New("UIStroke", { Color = Theme.Stroke, Thickness = 1 }),
    })
    local grad = New("UIGradient", {
        Rotation = 25,
        Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Theme.AccentA),
            ColorSequenceKeypoint.new(1, Theme.AccentB)
        },
        Transparency = NumberSequence.new{
            NumberSequenceKeypoint.new(0, 0.98),
            NumberSequenceKeypoint.new(1, 0.98)
        },
        Parent = frame
    })
    Components.DropShadow(frame, 18)
    return frame, grad
end

function Components.TopBar(props)
    local top = New("Frame", {
        Size = UDim2.new(1, 0, 0, 32),
        BackgroundTransparency = 1,
        Parent = props.Parent,
        Name = "TopBar",
        ZIndex = 2,
    })
    local glass = New("Frame", {
        Size = UDim2.fromScale(1,1),
        BackgroundColor3 = Theme.Surface,
        BackgroundTransparency = 0,
        Parent = top,
        ZIndex = 2,
    }, {
        New("UICorner", { CornerRadius = UDim.new(0, 16) }),
        New("UIStroke", { Color = Theme.Stroke, Thickness = 1, Transparency = 0.5 }),
        New("UIGradient", { Rotation = 90, Color = ColorSequence.new(Theme.AccentB, Theme.AccentA), Transparency = NumberSequence.new(0.95) })
    })
    local title = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 14, 0, 0),
        Size = UDim2.new(1, -14, 1, 0),
        Text = props.Title or "GUI Base",
        Font = Enum.Font.GothamBold,
        TextSize = 16,
        TextColor3 = Theme.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = top,
        ZIndex = 3,
    })
    return top, glass, title
end

function Components.PillButton(props)
    local b = New("TextButton", {
        Size = props.Size or UDim2.new(0, 26, 0, 26),
        BackgroundColor3 = props.Bg or Theme.DefaultButton,
        Text = props.Text or "",
        TextColor3 = Theme.Text,
        Font = Enum.Font.GothamSemibold,
        TextSize = props.TextSize or 14,
        Parent = props.Parent,
        Name = props.Name or "Button",
        AutoButtonColor = false,
        ZIndex = props.ZIndex or 2,
        LayoutOrder = props.LayoutOrder or 0
    }, {
        New("UICorner", { CornerRadius = UDim.new(0, 8) }),
        New("UIStroke", { Color = Theme.Stroke, Thickness = 1, Transparency = 0.5 })
    })

    Components.SetState(b, "off", props.Bg or Theme.DefaultButton)

    bind(b.MouseEnter:Connect(function()
        local currentState = UIState[b]
        local base = (currentState and currentState.color) or b.BackgroundColor3
        TweenService:Create(b, TweenInfo.new(0.12, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {
            BackgroundColor3 = base:lerp(Theme.AccentB, 0.25)
        }):Play()
    end))

    bind(b.MouseLeave:Connect(function()
        local currentState = UIState[b]
        local targetColor = (currentState and currentState.color) or Theme.DefaultButton
        TweenService:Create(b, TweenInfo.new(0.18, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {
            BackgroundColor3 = targetColor
        }):Play()
    end))

    return b
end

function Components.SectionLabel(text, parent, y)
    return New("TextLabel", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 0, 24),
        Position = UDim2.new(0, 10, 0, y or 10),
        Font = Enum.Font.GothamBold,
        TextSize = 16,
        TextColor3 = Theme.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        Text = text,
        Parent = parent,
        ZIndex = 2,
    })
end

local function headerRectOf(container)
    local p = container.AbsolutePosition
    local s = container.AbsoluteSize
    return p.X, p.Y, s.X, s.Y
end
local function viewportSize()
    local cam = workspace.CurrentCamera
    return cam and cam.ViewportSize or Vector2.new(1920,1080)
end

function Components.MultiSelectDropdown(props)
    ensureOverlay()
    local BASE_Z = props.ZIndex or 50
    local MAX_MENU_HEIGHT = props.MaxHeight or 220
    local GAP = 4

    local container = New("Frame", {
        Parent = props.Parent,
        Size = props.Size or UDim2.new(0, 180, 0, 30),
        BackgroundColor3 = Theme.Surface,
        BackgroundTransparency = 0,
        ZIndex = BASE_Z,
        ClipsDescendants = false,
        Name = props.Name or "MultiSelectDropdown",
    }, {
        New("UICorner", { CornerRadius = UDim.new(0, 8) }),
        New("UIStroke", { Color = Theme.Stroke, Thickness = 1 }),
    })

    New("TextLabel", {
        Parent = container, BackgroundTransparency = 1, Size = UDim2.new(1, -10, 0, 14),
        Position = UDim2.new(0, 8, 0, 3), Font = Enum.Font.GothamSemibold, TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = Theme.Muted, Text = props.Title or "",
        ZIndex = BASE_Z + 1
    })

    local openBtn = New("TextButton", {
        Parent = container, BackgroundTransparency = 1, Size = UDim2.new(1, -28, 0, 16),
        Position = UDim2.new(0, 6, 0, 14), Font = Enum.Font.Gotham, TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = Theme.Text, Text = "All selected",
        AutoButtonColor = false, ZIndex = BASE_Z + 1
    })

    New("TextLabel", {
        Parent = container, BackgroundTransparency = 1, Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(1, -20, 0, 14), Font = Enum.Font.GothamBold, TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Center, TextColor3 = Theme.Muted, Text = "▲", ZIndex = BASE_Z + 1
    })

    local optionsFrame = New("ScrollingFrame", {
        Parent = ensureOverlay(), BackgroundColor3 = Theme.Card, BackgroundTransparency = 0,
        Position = UDim2.fromOffset(0,0), Size = UDim2.fromOffset(0,0), ZIndex = 100000, Visible = false,
        ClipsDescendants = true, Name = "Options_" .. (props.Title or "Filter"),
        ScrollingDirection = Enum.ScrollingDirection.Y, ScrollBarThickness = 6, ScrollBarImageTransparency = 0.5,
        Active = true, AutomaticCanvasSize = Enum.AutomaticSize.Y, CanvasSize = UDim2.new(0,0,0,0),
    }, {
        New("UICorner", { CornerRadius = UDim.new(0, 8) }),
        New("UIStroke", { Color = Theme.Stroke, Thickness = 1 })
    })

    local list = New("UIListLayout", { Parent = optionsFrame, FillDirection = Enum.FillDirection.Vertical, Padding = UDim.new(0,4), SortOrder = Enum.SortOrder.LayoutOrder })
    local padding = New("UIPadding", { Parent = optionsFrame, PaddingLeft = UDim.new(0,6), PaddingTop = UDim.new(0,6), PaddingRight = UDim.new(0,6), PaddingBottom = UDim.new(0,6) })

    local open = false
    local items, selected = {}, props.InitialItems or {}
    local colorMap = props.ColorMap or {}

    local function desiredMenuHeight()
        local abs = list.AbsoluteContentSize
        local desired = abs.Y + padding.PaddingTop.Offset + padding.PaddingBottom.Offset
        return math.clamp(desired, 0, MAX_MENU_HEIGHT)
    end
    local function placeMenu(targetHeight)
        local x, y, w = headerRectOf(container)
        local view = viewportSize()
        local width = math.floor(math.min(w, view.X - 8))
        local height = math.floor(targetHeight or 0)
        local xClamped = math.clamp(x, 4, math.max(4, view.X - width - 4))
        local yTop = math.max(4, y - GAP - height)
        optionsFrame.Position = UDim2.fromOffset(xClamped, yTop)
        optionsFrame.Size = UDim2.fromOffset(width, height)
    end

    local function updateSummary()
        local count, total = 0, #items
        for _, name in ipairs(items) do if selected[name] then count += 1 end end
        if count == 0 then openBtn.Text = "None selected"
        elseif count <= 2 then
            local names = {}
            for _, name in ipairs(items) do if selected[name] then table.insert(names, name) end end
            openBtn.Text = table.concat(names, ", ")
        else
            openBtn.Text = tostring(count) .. " selected"
        end
    end
    updateSummary()

    local function setOptionButtonState(btn, isOn, name)
        local bg = isOn and Theme.Success or Theme.DefaultButton
        TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), { BackgroundColor3 = bg }):Play()
        btn.NameLabel.TextColor3 = colorMap[name] or Theme.Text
        btn.Checkmark.TextTransparency = isOn and 0 or 0.7
    end

    local function rebuildOptions()
        for _, child in ipairs(optionsFrame:GetChildren()) do if child:IsA("TextButton") then child:Destroy() end end
        for i, name in ipairs(items) do
            local opt = New("TextButton", {
                Parent = optionsFrame, Size = UDim2.new(1,0,0,28), BackgroundColor3 = Theme.DefaultButton,
                AutoButtonColor = false, Text = "", ZIndex = optionsFrame.ZIndex + 1, LayoutOrder = i
            }, {
                New("UICorner", { CornerRadius = UDim.new(0,6) }),
                New("UIStroke", { Color = Theme.Stroke, Thickness = 1, Transparency = 0.4 })
            })
            New("TextLabel", {
                Parent = opt, BackgroundTransparency = 1, Position = UDim2.new(0,8,0,0), Size = UDim2.new(1,-48,1,0),
                Font = Enum.Font.Gotham, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Text = name,
                TextColor3 = colorMap[name] or Theme.Text, Name = "NameLabel", ZIndex = optionsFrame.ZIndex + 2
            })
            New("TextLabel", {
                Parent = opt, BackgroundTransparency = 1, Size = UDim2.new(0,24,0,24), Position = UDim2.new(1,-26,0.5,-12),
                Font = Enum.Font.GothamBold, TextSize = 16, Text = "✓", TextColor3 = Color3.fromRGB(255,255,255), TextTransparency = 0.7,
                Name = "Checkmark", ZIndex = optionsFrame.ZIndex + 2
            })
            bind(opt.MouseButton1Click:Connect(function()
                selected[name] = not selected[name]
                setOptionButtonState(opt, selected[name], name)
                updateSummary()
                if props.OnChanged then props.OnChanged(selected) end
            end))
            setOptionButtonState(opt, selected[name] == true, name)
        end
        task.defer(function() if open and optionsFrame.Visible then placeMenu(desiredMenuHeight()) end end)
    end

    local function setOpen(v)
        if open == v then return end
        open = v
        if v then
            optionsFrame.Visible = true
            optionsFrame.CanvasPosition = Vector2.new(0,0)
            placeMenu(desiredMenuHeight())
        else
            optionsFrame.Visible = false
        end
    end

    local api = {}
    function api.Close() setOpen(false) end
    function api.SetItems(newItems, preserveSelection)
        local seen = {}
        items = {}
        if not preserveSelection then selected = {} end
        for _, n in ipairs(newItems or {}) do 
            if n and not seen[n] then 
                seen[n]=true; 
                table.insert(items, n) 
                if selected[n] == nil then selected[n] = false end
            end 
        end
        rebuildOptions(); updateSummary()
    end
    if props.InitialItems then
        for k,v in pairs(props.InitialItems) do selected[k] = v end
    end
    updateSummary()
    function api.GetSelected() return selected end

    registerDropdown(api)
    bind(openBtn.MouseButton1Click:Connect(function() setOpen(not open) end))
    if workspace.CurrentCamera then
        bind(workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(function() if open then placeMenu(desiredMenuHeight()) end end))
    end
    bind(container:GetPropertyChangedSignal("AbsolutePosition"):Connect(function() if open then placeMenu(desiredMenuHeight()) end end))
    bind(container:GetPropertyChangedSignal("AbsoluteSize"):Connect(function() if open then placeMenu(desiredMenuHeight()) end end))
    bind(list:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function() if open then placeMenu(desiredMenuHeight()) end end))
    bind(UserInputService.InputBegan:Connect(function(input, gp)
        if gp or not open or input.UserInputType ~= Enum.UserInputType.MouseButton1 then return end
        local pos = input.Position
        local cPos, cSize = container.AbsolutePosition, container.AbsoluteSize
        local oPos, oSize = optionsFrame.AbsolutePosition, optionsFrame.AbsoluteSize
        local inHeader = pos.X >= cPos.X and pos.X <= cPos.X+cSize.X and pos.Y >= cPos.Y and pos.Y <= cPos.Y+cSize.Y
        local inMenu = pos.X >= oPos.X and pos.X <= oPos.X+oSize.X and pos.Y >= oPos.Y and pos.Y <= oPos.Y+oSize.Y
        if not inHeader and not inMenu then setOpen(false) end
    end))

    api.SetItems(props.Items or {}, true)
    return api, container
end

local islandAutoTeleport = config.islandAutoTeleport
local islandVisitCount = 0
local visitedIslands = {}
local activeIslandInfo = "None"

local function findDescendant(parent, name)
    if not parent then return nil end
    local result = parent:FindFirstChild(name)
    if result then return result end
    for _, child in ipairs(parent:GetChildren()) do
        result = findDescendant(child, name)
        if result then return result end
    end
    return nil
end

local function isSpecialIsland(child)
    if not child or not child:IsA("Model") then return false end
    local names = {"luck", "roll", "mythic", "divine", "secret", "admin", "mutation"}
    local n = child.Name:lower()
    for _, name in ipairs(names) do
        if n:find(name) then return true end
    end
    local info = child:FindFirstChild("IslandInfo")
    local gui = info and (info:FindFirstChild("IslandGUI") or info:FindFirstChild("IslandGui"))
    local nameLabel = gui and (gui:FindFirstChild("IslandName") or gui:FindFirstChild("NameLabel"))
    if nameLabel and nameLabel:IsA("TextLabel") then
        local txt = nameLabel.Text:lower()
        for _, name in ipairs(names) do
            if txt:find(name) then return true end
        end
    end
    return false
end

local lastIslandFound = nil
local function findIslandModel()
    local found = nil
    for _, child in ipairs(Workspace:GetChildren()) do
        if isSpecialIsland(child) then
            found = child
            break
        end
    end
    lastIslandFound = found
    return found
end

local function checkIslandTeleport()
    if unloaded or not config.islandAutoTeleport then return end
    local island = findIslandModel()
    if island and not visitedIslands[island] then
        visitedIslands[island] = true
        task.wait(5)
        local tp = island:FindFirstChild("Teleport")
        if tp then
            islandVisitCount = islandVisitCount + 1
            local root = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if root then root.CFrame = tp.CFrame end
        end
    end
end
task.spawn(function()
    while not unloaded do
        if config.islandAutoTeleport then checkIslandTeleport() end
        task.wait(2.4)
    end
end)

local function getIslandInfo()
    local luckIsland = findIslandModel()
    if luckIsland then
        local gui = luckIsland:FindFirstChild("IslandInfo") or luckIsland:FindFirstChild("IslandGui", true)
        if gui then
             local iName = findDescendant(gui, "IslandName")
             local iTime = findDescendant(gui, "IslandTimer")
             if iName and iTime then
                  return iName.Text .. " - " .. iTime.Text
             end
        end
        return luckIsland.Name .. " (Active)"
    end
    return "No Active Island"
end

local function getRareBoardInfo()
    local board = Workspace:FindFirstChild("Special")
    if board then board = board:FindFirstChild("CurrentEvents") end
    if board then board = board:FindFirstChild("RareBoard") end
    if board then board = board:FindFirstChild("SurfaceGui") end
    if board then board = board:FindFirstChild("Heading") end
    if board and board:IsA("TextLabel") then
        return board.Text
    end
    return "Unknown Board Status"
end

local function walkTo(pos)
    local char = Players.LocalPlayer.Character
    local hum = char and char:FindFirstChild("Humanoid")
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hum or not hrp then return end
    
    local path = PathfindingService:CreatePath({AgentRadius = 2, AgentHeight = 5, AgentCanJump = true, AgentMaxSlope = 50})
    local success, _ = pcall(function() path:ComputeAsync(hrp.Position, pos) end)
    
    if success and path.Status == Enum.PathStatus.Success then
        local waypoints = path:GetWaypoints()
        for i, wp in ipairs(waypoints) do
            if i > 1 then
                hum:MoveTo(wp.Position)
                local t = os.clock()
                local stuckTime = 0
                
                while (Vector3.new(hrp.Position.X, 0, hrp.Position.Z) - Vector3.new(wp.Position.X, 0, wp.Position.Z)).Magnitude > 4 do
                    if not config.autoBuyActive or unloaded then return end
                    
                    if (hrp.Velocity * Vector3.new(1,0,1)).Magnitude < 0.2 then
                        stuckTime = stuckTime + 0.1
                        if stuckTime > 1.5 then
                            hum.Jump = true
                            hum:MoveTo(wp.Position)
                            stuckTime = 0
                        end
                    else
                        stuckTime = 0
                    end
                    
                    if os.clock() - t > 10 then break end
                    task.wait(0.1)
                end
            end
        end
    else
        hum:MoveTo(pos)
        local t = os.clock()
        while (Vector3.new(hrp.Position.X, 0, hrp.Position.Z) - Vector3.new(pos.X, 0, pos.Z)).Magnitude > 4 do
             if not config.autoBuyActive or unloaded or os.clock() - t > 15 then break end
             hum:MoveTo(pos)
             if (hrp.Velocity * Vector3.new(1,0,1)).Magnitude < 0.2 then hum.Jump = true end
             task.wait(0.1)
        end
    end
end

local isInteracting = false
local function interactNPC()
    if isInteracting then return end
    isInteracting = true
    
    local potentialPath = Workspace:FindFirstChild("NPCs") and Workspace.NPCs:FindFirstChild("Shopkeeper")
    local npc = potentialPath or Workspace:FindFirstChild("Shopkeeper", true) or findDescendant(Workspace, "Shopkeeper")
    if not npc then isInteracting = false return end
    
    local prompt = findDescendant(npc, "TalkPrompt")
    local char = Players.LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp or not prompt then isInteracting = false return end
    
    local targetHrp = npc:FindFirstChild("HumanoidRootPart") or (npc:IsA("BasePart") and npc) or findDescendant(npc, "HumanoidRootPart")
    if not targetHrp then isInteracting = false return end
    
    local startPos = hrp.Position
    if config.shopWaypoint then walkTo(Vector3.new(config.shopWaypoint.X, config.shopWaypoint.Y, config.shopWaypoint.Z)) end
    
    walkTo(targetHrp.Position)
    local dist = (Vector3.new(hrp.Position.X, 0, hrp.Position.Z) - Vector3.new(targetHrp.Position.X, 0, targetHrp.Position.Z)).Magnitude
    
    if config.autoBuyActive and dist <= 18 then
        if fireproximityprompt then fireproximityprompt(prompt)
        else prompt:InputHoldBegin(); task.wait(0.6); prompt:InputHoldEnd() end
        task.wait(2.5)
        if config.shopWaypoint then walkTo(Vector3.new(config.shopWaypoint.X, config.shopWaypoint.Y, config.shopWaypoint.Z)) end
        walkTo(startPos)
    end
    
    isInteracting = false
end

local function openOkMartUI()
    interactNPC()
end

local function getStoreItems()
    local items = {}
    local pg = Players.LocalPlayer:FindFirstChild("PlayerGui")
    local store = pg and pg:FindFirstChild("Store")
    if not store then return items end
    local sf = findDescendant(store, "SF") or findDescendant(store, "ScrollingFrame")
    if sf then
        for _, item in ipairs(sf:GetChildren()) do
            local title = item:FindFirstChild("TitleLabel") or findDescendant(item, "Title") or findDescendant(item, "Name")
            if title and (title:IsA("TextLabel") or title:IsA("TextBox")) then
                local idx = tonumber(item.Name:match("%d+")) or 0
                table.insert(items, { element = item, name = title.Text, index = idx })
            end
        end
    end
    return items
end

local capturedArgs = {}
local function logCapture(rem, args)
    local s = "[REMOTESPY] Captured " .. tostring(rem) .. " | Args: {"
    for i, v in ipairs(args) do
        local vt = type(v)
        local val = vt == "string" and '"'..v..'"' or tostring(v)
        if vt == "table" then val = "{...}" end
        s = s .. val .. (i < #args and ", " or "")
    end
    print(s .. "}")
end

local function hookRemote(rem)
    if not rem or not rem:IsA("RemoteEvent") then return end
    pcall(function()
        local old; old = hookfunction(rem.FireServer, function(self, ...)
            if not unloaded and config.remoteSpyEnabled and (tostring(self):lower():find("purchase") or self.Name:lower():find("purchase")) then
                capturedArgs = {...}
                logCapture(self, capturedArgs)
            end
            return old(self, ...)
        end)
    end)
end

pcall(function()
    local hm = hookmetamethod or (syn and syn.hook_metamethod)
    local gnm = getnamecallmethod or (syn and syn.get_namecall_method)
    if hm and gnm then
        local old; old = hm(game, "__namecall", function(self, ...)
            local method = gnm()
            if not unloaded and config.remoteSpyEnabled and (method:lower() == "fireserver") then
                if tostring(self):lower():find("purchase") or self.Name:lower():find("purchase") then
                    capturedArgs = {...}
                    logCapture(self, capturedArgs)
                end
            end
            return old(self, ...)
        end)
    end
end)

pcall(function()
    local re = Instance.new("RemoteEvent")
    local old; old = hookfunction(re.FireServer, function(self, ...)
        if not unloaded and config.remoteSpyEnabled and (tostring(self):lower():find("purchase") or self.Name:lower():find("purchase")) then
            capturedArgs = {...}
            logCapture(self, capturedArgs)
        end
        return old(self, ...)
    end)
end)

local lastBuyTime = 0
local function tryAutoBuy(matchName, index)
    if tick() - lastBuyTime < 1 then return end
    local remote = ReplicatedStorage:FindFirstChild("PurchaseItem", true) or ReplicatedStorage:FindFirstChild("Purchase", true)
    if not remote or not remote:IsA("RemoteEvent") then return end
    lastBuyTime = tick()
    if index and index > 0 then remote:FireServer(index)
    elseif capturedArgs and #capturedArgs > 0 then remote:FireServer(unpack(capturedArgs))
    else remote:FireServer(matchName) end
end

local lastWalkTime = 0
task.spawn(function()
    while not unloaded do
        if config.autoBuyActive then
            local island = findIslandModel()
            if island then
                local t = tick()
                while findIslandModel() and config.autoBuyActive and not unloaded do
                    task.wait(1)
                end
                if not config.autoBuyActive or unloaded then continue end
            end
            
            local items = getStoreItems()
            local pg = Players.LocalPlayer:FindFirstChild("PlayerGui")
            local store = pg and pg:FindFirstChild("Store")
            local mainFrame = store and store:FindFirstChild("MainFrame")
            local uiOpen = mainFrame and mainFrame.Visible
            
            if not uiOpen or (uiOpen and #items == 0) then
                if not isInteracting then
                    openOkMartUI()
                    task.wait(2)
                end
                items = getStoreItems()
            end
            if #items > 0 then
                for _, item in ipairs(items) do
                    if not config.autoBuyActive then break end
                    local shouldBuy = false
                    for target, enabled in pairs(config.autoBuyList) do
                        if enabled and item.name:lower():find(target:lower()) then
                            shouldBuy = true
                            break
                        end
                    end
                    if shouldBuy then
                        local label = item.element:FindFirstChild("TitleLabel")
                        local txt = label and label.Text or item.name
                        if not txt:lower():find("sold out") then
                            local stock = txt:match("%[(%d+)/%d+%]")
                            if (stock and tonumber(stock) > 0) or (not stock and not txt:lower():find("0/")) then
                                tryAutoBuy(item.name, item.index)
                                task.wait(1.5)
                            end
                        end
                    end
                end
            end
        end
        task.wait(2)
    end
end)

local serverBrowserEnabled = false
local boostTiers = {
    ["2x Luck"] = {tier = 1, type = "Luck"},
    ["4x Luck"] = {tier = 2, type = "Luck"},
    ["8x Luck"] = {tier = 3, type = "Luck"},
    ["+1 Roll"] = {tier = 1, type = "Roll"},
    ["+2 Roll"] = {tier = 2, type = "Roll"},
    ["+3 Roll"] = {tier = 3, type = "Roll"},
}

local function getBoostInfo(text)
    for name, info in pairs(boostTiers) do if text:find(name) then return info end end
    return {tier = 0, type = "None"}
end

local function getCurrentBoost(srvs)
    local jid = tostring(game.JobId)
    for _, s in ipairs(srvs) do if s.id == jid then return s.boost end end
    return "None"
end

local function findRefreshButton()
    local pg = Players.LocalPlayer:FindFirstChild("PlayerGui")
    local sb = pg and pg:FindFirstChild("ServerBrowser")
    return sb and (findDescendant(sb, "RefreshButton") or findDescendant(sb, "Refresh"))
end

local function triggerRefresh()
    local btn = findRefreshButton()
    if btn then
        if type(firesignal) == "function" then firesignal(btn.MouseButton1Click) end
    else
        local rem = ReplicatedStorage:FindFirstChild("RefreshServers", true)
        if rem and rem:IsA("RemoteEvent") then rem:FireServer() end
    end
end

local function readServerList()
    local found = {}
    local pg = Players.LocalPlayer:FindFirstChild("PlayerGui")
    local sb = pg and pg:FindFirstChild("ServerBrowser")
    if sb then
        local container = findDescendant(sb, "ItemsContainer")
        local sf = container and (container:FindFirstChild("SF") or container)
        if sf then
            for _, s in ipairs(sf:GetChildren()) do
                if (s:IsA("Frame") or s:IsA("Folder")) and s.Name ~= "UIListLayout" and s.Name ~= "UIPadding" then
                    local boost = findDescendant(s, "BoostLabel")
                    local loc = findDescendant(s, "Location")
                    local cnt = findDescendant(s, "PlayerCount")
                    table.insert(found, {
                        id = s.Name,
                        boost = boost and boost.Text or "Unknown",
                        location = loc and loc.Text or "Unknown",
                        count = cnt and cnt.Text or "?"
                    })
                end
            end
        end
    end
    return found
end

local function populateServerList(scrollingFrame)
    for _, c in ipairs(scrollingFrame:GetChildren()) do if c:IsA("Frame") then c:Destroy() end end
    local servers = readServerList()
    for _, s in ipairs(servers) do
        local f = New("Frame", {
            Parent = scrollingFrame, Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = Theme.Card,
        }, { New("UICorner", { CornerRadius = UDim.new(0, 6) }), New("UIStroke", { Color = Theme.Stroke, Thickness = 1 }) })
        New("TextLabel", { Parent = f, Position = UDim2.new(0, 10, 0, 0), Size = UDim2.new(0.4, 0, 0.5, 0), BackgroundTransparency = 1, Text = s.boost, TextColor3 = Theme.AccentB, Font = Enum.Font.GothamBold, TextXAlignment = Enum.TextXAlignment.Left })
        New("TextLabel", { Parent = f, Position = UDim2.new(0, 10, 0.5, 0), Size = UDim2.new(0.4, 0, 0.5, 0), BackgroundTransparency = 1, Text = s.location, TextColor3 = Theme.Muted, Font = Enum.Font.Gotham, TextXAlignment = Enum.TextXAlignment.Left })
        New("TextLabel", { Parent = f, Position = UDim2.new(0.65, 0, 0, 0), Size = UDim2.new(0.15, 0, 1, 0), BackgroundTransparency = 1, Text = s.count, TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextXAlignment = Enum.TextXAlignment.Right })
        local joinBtn = New("TextButton", { Parent = f, Size = UDim2.new(0, 50, 0, 24), Position = UDim2.new(1, -60, 0.5, -12), BackgroundColor3 = Theme.Success, Text = "Join", TextColor3 = Color3.new(1,1,1), Font = Enum.Font.GothamBold, TextSize = 12 }, { New("UICorner", { CornerRadius = UDim.new(0,4)}) })
        bind(joinBtn.MouseButton1Click:Connect(function() TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Players.LocalPlayer) end))
    end
end

local function buildGui()
    FX.TweenBlur(true)
    mainGui = New("ScreenGui", { Name = existingGuiName, ResetOnSpawn = false, ZIndexBehavior = Enum.ZIndexBehavior.Sibling, Parent = CoreGui })
    local frame, accentGrad = Components.Card({ Parent = mainGui, Name = "Root", Size = UDim2.new(0, 600, 0, 450), ZIndex = 1 })
    task.spawn(function()
        while frame.Parent and not unloaded do
            TweenService:Create(accentGrad, TweenInfo.new(6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { Rotation = 25 }):Play()
            task.wait(6)
            TweenService:Create(accentGrad, TweenInfo.new(6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { Rotation = -25 }):Play()
            task.wait(6)
        end
    end)
    local topBar = Components.TopBar({ Parent = frame, Title = "New Script Base" })
    local dragging, dragInput, dragStart, startCenter = false, nil, nil, nil
    local viewport = (workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize) or Vector2.new(1920,1080)
    if workspace.CurrentCamera then bind(workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(function() viewport = workspace.CurrentCamera.ViewportSize end)) end
    local function clamp(n,a,b) return n<a and a or n>b and b or n end
    local function updateDrag(input)
        if not dragging then return end
        local delta = input.Position - dragStart
        local cx, cy = startCenter.X + delta.X, startCenter.Y + delta.Y
        local absSize = frame.AbsoluteSize
        cx = clamp(cx, absSize.X/2, viewport.X - absSize.X/2)
        cy = clamp(cy, absSize.Y/2, viewport.Y - absSize.Y/2)
        frame.Position = UDim2.fromOffset(cx,cy)
    end
    bind(topBar.InputBegan:Connect(function(input)
        if not unloaded and (input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch) then
            dragging, dragStart = true, input.Position
            local absPos, absSize = frame.AbsolutePosition, frame.AbsoluteSize
            startCenter = Vector2.new(absPos.X + absSize.X/2, absPos.Y + absSize.Y/2)
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end))
    bind(topBar.InputChanged:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then dragInput = input end end))
    bind(UserInputService.InputChanged:Connect(function(input) if input == dragInput and dragging then updateDrag(input) end end))

    local pages = {}
    for _, name in ipairs({"Main", "Servers", "OkMart", "Settings"}) do
        pages[name] = New("Frame", { Name = name.."Page", Size = UDim2.new(1, -24, 1, -96), Position = UDim2.new(0, 12, 0, 46), BackgroundTransparency = 1, Parent = frame, ZIndex = 2, Visible = (name=="Main") })
    end
    local mainPage, serversPage, okMartPage, settingsPage = pages.Main, pages.Servers, pages.OkMart, pages.Settings

    local tabs = New("Frame", { Parent = frame, BackgroundTransparency = 1, Size = UDim2.new(0, 440, 0, 28), Position = UDim2.new(1, -452, 0, 2), ZIndex = 10 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, HorizontalAlignment = Enum.HorizontalAlignment.Right, VerticalAlignment = Enum.VerticalAlignment.Center, Padding = UDim.new(0,8), Parent = tabs })
    local tabBtns = {}
    for _, name in ipairs({"Main", "Servers", "OkMart", "Settings"}) do
        tabBtns[name] = Components.PillButton({ Parent = tabs, Size = UDim2.new(0, 70, 0, 26), Text = (name=="OkMart" and "OK Mart" or name), ZIndex = 11 })
        bind(tabBtns[name].MouseButton1Click:Connect(function()
            for k, p in pairs(pages) do p.Visible = (k == name) end
            for k, b in pairs(tabBtns) do Components.SetState(b, (k == name) and "on" or "off", (k == name) and Theme.ActiveTab or Theme.DefaultButton) end
        end))
    end
    local unloadTabBtn = Components.PillButton({ Parent = tabs, Size = UDim2.new(0, 70, 0, 26), Text = "Unload", ZIndex = 11, Bg = Color3.fromRGB(44, 20, 24) })
    bind(unloadTabBtn.MouseButton1Click:Connect(unload))
    Components.SetState(tabBtns.Main, "on", Theme.ActiveTab)

    local mainCard = Components.Card({ Parent = mainPage, Size = UDim2.new(1,0,1,0), Name = "MainCard", ZIndex = 2 })
    Components.SectionLabel("FEATURES", mainCard, 10)
    New("Frame", { Size = UDim2.new(1, -24, 0, 1), Position = UDim2.new(0, 12, 0, 38), BackgroundColor3 = Theme.Stroke, BackgroundTransparency = 0, Parent = mainCard, ZIndex = 2 })
    local row1 = New("Frame", { Size = UDim2.new(1, -24, 0, 36), Position = UDim2.new(0, 12, 0, 52), BackgroundTransparency = 1, Parent = mainCard, ZIndex = 2 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,8), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = row1 })
    New("TextLabel", { Size = UDim2.new(0, 160, 1, 0), BackgroundTransparency = 1, Text = "Island Auto Teleport", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 16, TextXAlignment = Enum.TextXAlignment.Left, Parent = row1 })
    local islandTpBtn = Components.PillButton({ Parent = row1, Size = UDim2.new(0, 28, 0, 28) })
    Components.SetState(islandTpBtn, config.islandAutoTeleport and "on" or "off", config.islandAutoTeleport and Theme.Success or Theme.DefaultButton)
    bind(islandTpBtn.MouseButton1Click:Connect(function()
        config.islandAutoTeleport = not config.islandAutoTeleport
        saveConfig()
        Components.SetState(islandTpBtn, config.islandAutoTeleport and "on" or "off", config.islandAutoTeleport and Theme.Success or Theme.DefaultButton)
    end))
    local rowF = New("Frame", { Size = UDim2.new(1, -24, 0, 30), Position = UDim2.new(0, 12, 0, 92), BackgroundTransparency = 1, Parent = mainCard, ZIndex = 60 })
    local hopItems = {"Any Boost", "2x Luck", "4x Luck", "8x Luck", "+1 Roll", "+2 Roll", "+3 Roll"}
    Components.MultiSelectDropdown({ Parent = rowF, Size = UDim2.new(0, 220, 0, 30), Title = "Server Filter", Items = hopItems, ZIndex = 60, InitialItems = config.serverFilters, OnChanged = function(sel) config.serverFilters = sel; saveConfig() end })
    local row2 = New("Frame", { Size = UDim2.new(1, -24, 0, 36), Position = UDim2.new(0, 12, 0, 132), BackgroundTransparency = 1, Parent = mainCard, ZIndex = 2 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,8), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = row2 })
    New("TextLabel", { Size = UDim2.new(0, 160, 1, 0), BackgroundTransparency = 1, Text = "Server Hop (Filtered)", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 16, TextXAlignment = Enum.TextXAlignment.Left, Parent = row2 })
    local hopBtn = Components.PillButton({ Parent = row2, Size = UDim2.new(0, 80, 0, 28), Text = "Hop Now" })
    bind(hopBtn.MouseButton1Click:Connect(function()
        triggerRefresh(); task.wait(1.5); local servers = readServerList(); local best = nil
        for _, s in ipairs(servers) do
            local comb = (s.boost.." "..s.location):lower()
            for k, v in pairs(config.serverFilters) do if v and (k=="Any Boost" and #comb>3 or comb:find(k:lower())) then best = s.id; break end end
            if best then break end
        end
        if best then TeleportService:TeleportToPlaceInstance(game.PlaceId, best, Players.LocalPlayer) else TeleportService:Teleport(game.PlaceId, Players.LocalPlayer) end
    end))
    local infoLabel = New("TextLabel", { Parent = mainCard, Size = UDim2.new(1, -24, 0, 100), Position = UDim2.new(0, 12, 0, 180), BackgroundTransparency = 1, Text = "Waiting for info...", TextColor3 = Theme.Muted, Font = Enum.Font.Gotham, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, TextYAlignment = Enum.TextYAlignment.Top, TextWrapped = true, ZIndex = 3 })
    task.spawn(function()
        while not unloaded do
            infoLabel.Text = "ACTIVE ISLAND: " .. getIslandInfo() .. "\n\nIslands Visited: " .. islandVisitCount .. "\n\nRARE BOARD: " .. getRareBoardInfo()
            task.wait(1)
        end
    end)

    local serversCard = Components.Card({ Parent = serversPage, Size = UDim2.new(1,0,1,0), Name = "ServersCard", ZIndex = 2 })
    Components.SectionLabel("SERVER BROWSER", serversCard, 10)
    New("Frame", { Size = UDim2.new(1, -24, 0, 1), Position = UDim2.new(0, 12, 0, 38), BackgroundColor3 = Theme.Stroke, BackgroundTransparency = 0, Parent = serversCard, ZIndex = 2 })
    local sCtrl = New("Frame", { Size = UDim2.new(1, -24, 0, 36), Position = UDim2.new(0, 12, 0, 52), BackgroundTransparency = 1, Parent = serversCard, ZIndex = 2 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,10), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = sCtrl })
    
    local refLabel = New("TextLabel", { Size = UDim2.new(0, 90, 1, 0), BackgroundTransparency = 1, Text = "Auto Refresh", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = sCtrl })
    local refBtn = Components.PillButton({ Parent = sCtrl, Size = UDim2.new(0, 28, 0, 28) })
    Components.SetState(refBtn, config.serverAutoRefresh and "on" or "off", config.serverAutoRefresh and Theme.Success or Theme.DefaultButton)
    
    local joinLabel = New("TextLabel", { Size = UDim2.new(0, 70, 1, 0), BackgroundTransparency = 1, Text = "Auto Join", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = sCtrl })
    local sJoinBtn = Components.PillButton({ Parent = sCtrl, Size = UDim2.new(0, 28, 0, 28) })
    Components.SetState(sJoinBtn, config.serverAutoJoin and "on" or "off", config.serverAutoJoin and Theme.Success or Theme.DefaultButton)
    
    local fCtrl = New("Frame", { Size = UDim2.new(1, -24, 0, 30), Position = UDim2.new(0, 12, 0, 92), BackgroundTransparency = 1, Parent = serversCard, ZIndex = 50 })
    Components.MultiSelectDropdown({ Parent = fCtrl, Size = UDim2.new(0, 220, 0, 30), Title = "Auto Join Filter", Items = hopItems, ZIndex = 60, InitialItems = config.autoJoinFilters, OnChanged = function(sel) config.autoJoinFilters = sel; saveConfig() end })
    local sList = New("ScrollingFrame", { Size = UDim2.new(1, -24, 1, -125), Position = UDim2.new(0, 12, 0, 125), BackgroundTransparency = 1, Parent = serversCard, ZIndex = 2, CanvasSize = UDim2.new(0,0,0,0), AutomaticCanvasSize = Enum.AutomaticSize.Y })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Vertical, Padding = UDim.new(0, 4), Parent = sList })
    local function runServerLogic()
        if not config.serverAutoRefresh or unloaded then return end
        task.spawn(function()
            local lastRef = 0
            while config.serverAutoRefresh and not unloaded do
                if tick() - lastRef > 5 then
                    triggerRefresh()
                    lastRef = tick()
                    task.wait(2.6)
                end
                local srvs = readServerList()
                populateServerList(sList)
                if config.serverAutoJoin then
                    local curInf = getBoostInfo(getCurrentBoost(srvs))
                    for _, s in ipairs(srvs) do
                        if s.id ~= tostring(game.JobId) then
                            local c = tonumber((s.count:match("(%d+)") or "21"))
                            if c and c <= 19 then
                                local comb = (s.boost .. " " .. s.location):lower()
                                local matches = false
                                for k, v in pairs(config.autoJoinFilters) do if v and (k=="Any Boost" and #comb>3 or comb:find(k:lower())) then matches = true; break end end
                                if matches then
                                    local nInf = getBoostInfo(s.boost)
                                    local should = false
                                    if nInf.tier > curInf.tier then should = true
                                    elseif nInf.tier == curInf.tier and nInf.tier > 0 then
                                        if config.serverPreference == "Luck" and nInf.type == "Luck" and curInf.type ~= "Luck" then should = true
                                        elseif config.serverPreference == "Rolls" and nInf.type == "Roll" and curInf.type ~= "Roll" then should = true
                                        end
                                    end
                                    if should then TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Players.LocalPlayer); break end
                                end
                            end
                        end
                    end
                end
                task.wait(5)
            end
        end)
    end

    bind(refBtn.MouseButton1Click:Connect(function()
        config.serverAutoRefresh = not config.serverAutoRefresh
        saveConfig()
        Components.SetState(refBtn, config.serverAutoRefresh and "on" or "off", config.serverAutoRefresh and Theme.Success or Theme.DefaultButton)
        if config.serverAutoRefresh then runServerLogic() end
    end))
    if config.serverAutoRefresh then runServerLogic() end

    bind(sJoinBtn.MouseButton1Click:Connect(function()
        config.serverAutoJoin = not config.serverAutoJoin
        saveConfig()
        Components.SetState(sJoinBtn, config.serverAutoJoin and "on" or "off", config.serverAutoJoin and Theme.Success or Theme.DefaultButton)
        if config.serverAutoJoin and not config.serverAutoRefresh then
            config.serverAutoRefresh = true
            saveConfig()
            Components.SetState(refBtn, "on", Theme.Success)
            runServerLogic()
        end
    end))

    local pCtrl = New("Frame", { Size = UDim2.new(1, -24, 0, 30), Position = UDim2.new(0, 12, 0, 125), BackgroundTransparency = 1, Parent = serversCard, ZIndex = 2 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,8), Parent = pCtrl })
    New("TextLabel", { Size = UDim2.new(0, 100, 1, 0), BackgroundTransparency = 1, Text = "Join Priority", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = pCtrl })
    local lBtn = Components.PillButton({ Parent = pCtrl, Size = UDim2.new(0, 60, 0, 26), Text = "Luck" })
    local rBtn = Components.PillButton({ Parent = pCtrl, Size = UDim2.new(0, 60, 0, 26), Text = "Rolls" })
    local function upPref()
        Components.SetState(lBtn, config.serverPreference == "Luck" and "on" or "off", config.serverPreference == "Luck" and Theme.Success or Theme.DefaultButton)
        Components.SetState(rBtn, config.serverPreference == "Rolls" and "on" or "off", config.serverPreference == "Rolls" and Theme.Success or Theme.DefaultButton)
    end
    bind(lBtn.MouseButton1Click:Connect(function() config.serverPreference = "Luck"; saveConfig(); upPref() end))
    bind(rBtn.MouseButton1Click:Connect(function() config.serverPreference = "Rolls"; saveConfig(); upPref() end))
    upPref()

    local sListContainer = sList 
    sList.Position = UDim2.new(0, 12, 0, 160)
    sList.Size = UDim2.new(1, -24, 1, -160)

    local okCard = Components.Card({ Parent = okMartPage, Size = UDim2.new(1,0,1,0), ZIndex = 2 })
    Components.SectionLabel("OK MART STOCK", okCard, 10)
    New("Frame", { Size = UDim2.new(1, -24, 0, 1), Position = UDim2.new(0, 12, 0, 38), BackgroundColor3 = Theme.Stroke, BackgroundTransparency = 0, Parent = okCard, ZIndex = 2 })
    
    local okStatic = New("Frame", { Size = UDim2.new(1, -24, 0, 70), Position = UDim2.new(0, 12, 0, 45), BackgroundTransparency = 1, Parent = okCard, ZIndex = 3 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Vertical, Padding = UDim.new(0,4), Parent = okStatic })
    
    local spyRow = New("Frame", { Parent = okStatic, Size = UDim2.new(1,0,0,24), BackgroundTransparency = 1, ZIndex = 3 })
    local spyStatusLabel = New("TextLabel", { Parent = spyRow, Size = UDim2.new(0.7,0,1,0), Text = "Spy Status: Waiting for Capture...", Font = Enum.Font.Gotham, TextSize = 12, TextColor3 = Theme.Muted, BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, ZIndex = 3 })
    local clrBtn = New("TextButton", { Parent = spyRow, Size = UDim2.new(0, 50, 0, 20), Position = UDim2.new(1, -55, 0, 2), Text = "Clear", BackgroundColor3 = Theme.Danger, TextColor3 = Color3.new(1,1,1), Font = Enum.Font.Gotham, Visible = false, ZIndex = 4 }, { New("UICorner", { CornerRadius = UDim.new(0,4)}) })
    bind(clrBtn.MouseButton1Click:Connect(function() capturedArgs = {}; clrBtn.Visible = false; spyStatusLabel.Text = "Spy Status: Waiting for Capture..."; spyStatusLabel.TextColor3 = Theme.Muted end))

    local autoRow = New("Frame", { Parent = okStatic, Size = UDim2.new(1,0,0,36), BackgroundTransparency = 1, ZIndex = 5 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,8), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = autoRow })
    New("TextLabel", { Parent = autoRow, Size = UDim2.new(0, 70, 1, 0), Text = "Auto Buy", Font = Enum.Font.GothamBold, TextSize = 14, TextColor3 = Theme.Text, BackgroundTransparency = 1, ZIndex = 5 })
    local abToggle = Components.PillButton({ Parent = autoRow, Size = UDim2.new(0, 28, 0, 28), ZIndex = 5 })
    bind(abToggle.MouseButton1Click:Connect(function()
        config.autoBuyActive = not config.autoBuyActive
        saveConfig()
        Components.SetState(abToggle, config.autoBuyActive and "on" or "off", config.autoBuyActive and Theme.Success or Theme.DefaultButton)
    end))
    Components.SetState(abToggle, config.autoBuyActive and "on" or "off", config.autoBuyActive and Theme.Success or Theme.DefaultButton)
    Components.MultiSelectDropdown({ Parent = autoRow, Size = UDim2.new(0, 220, 0, 30), Title = "Target Items", Items = {"double Luck", "triple Luck", "+1 Roll"}, ZIndex = 60, InitialItems = config.autoBuyList, OnChanged = function(sel) config.autoBuyList = sel; saveConfig() end })

    local okScroll = New("ScrollingFrame", { Size = UDim2.new(1, -24, 1, -125), Position = UDim2.new(0, 12, 0, 125), BackgroundTransparency = 1, Parent = okCard, ZIndex = 2, CanvasSize = UDim2.new(0,0,0,0), AutomaticCanvasSize = Enum.AutomaticSize.Y })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Vertical, Padding = UDim.new(0, 4), Parent = okScroll })
    
    task.spawn(function()
        while not unloaded do
            if okMartPage.Visible then
                if #capturedArgs > 0 then
                    spyStatusLabel.Text = "Spy Status: Ready (Captured)"
                    spyStatusLabel.TextColor3 = Theme.Success
                    clrBtn.Visible = true
                end
                
                for _, c in ipairs(okScroll:GetChildren()) do if c:IsA("Frame") then c:Destroy() end end
                local items = getStoreItems()
                for _, item in ipairs(items) do
                    local f = New("Frame", { Parent = okScroll, Size = UDim2.new(1, 0, 0, 36), BackgroundColor3 = Theme.Card, BorderColor3 = Theme.Stroke, BorderSizePixel = 1 }, { New("UICorner", { CornerRadius = UDim.new(0,6)}) })
                    New("TextLabel", { Parent = f, Size = UDim2.new(0.6,0,1,0), Position = UDim2.new(0,10,0,0), Text = item.name, Font = Enum.Font.GothamBold, TextSize = 14, TextColor3 = Theme.Text, BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left })
                    local b = New("TextButton", { Parent = f, Size = UDim2.new(0,80,0,24), Position = UDim2.new(1,-90, 0.5,-12), Text = "Buy Now", BackgroundColor3 = Theme.DefaultButton, TextColor3 = Theme.Text, Font = Enum.Font.Gotham }, { New("UICorner", { CornerRadius = UDim.new(0,4)}) })
                    bind(b.MouseButton1Click:Connect(function() tryAutoBuy(item.name, item.index) end))
                end
            end
            task.wait(2.2)
        end
    end)

    local setCard = Components.Card({ Parent = settingsPage, Size = UDim2.new(1,0,1,0), ZIndex = 2 })
    Components.SectionLabel("SETTINGS", setCard, 10)
    New("Frame", { Size = UDim2.new(1, -24, 0, 1), Position = UDim2.new(0, 12, 0, 38), BackgroundColor3 = Theme.Stroke, BackgroundTransparency = 0, Parent = setCard, ZIndex = 2 })
    
    local spyRow = New("Frame", { Size = UDim2.new(1, -24, 0, 36), Position = UDim2.new(0, 12, 0, 46), BackgroundTransparency = 1, Parent = setCard, ZIndex = 2 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,8), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = spyRow })
    New("TextLabel", { Size = UDim2.new(0, 160, 1, 0), BackgroundTransparency = 1, Text = "Remote Spy (Capture)", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = spyRow })
    local spyBtn = Components.PillButton({ Parent = spyRow, Size = UDim2.new(0, 28, 0, 28) })
    bind(spyBtn.MouseButton1Click:Connect(function()
        config.remoteSpyEnabled = not config.remoteSpyEnabled
        saveConfig()
        Components.SetState(spyBtn, config.remoteSpyEnabled and "on" or "off", config.remoteSpyEnabled and Theme.Success or Theme.DefaultButton)
    end))
    Components.SetState(spyBtn, config.remoteSpyEnabled and "on" or "off", config.remoteSpyEnabled and Theme.Success or Theme.DefaultButton)
    
    local wpRow = New("Frame", { Size = UDim2.new(1, -24, 0, 36), Position = UDim2.new(0, 12, 0, 115), BackgroundTransparency = 1, Parent = setCard, ZIndex = 2 })
    New("UIListLayout", { FillDirection = Enum.FillDirection.Horizontal, Padding = UDim.new(0,10), VerticalAlignment = Enum.VerticalAlignment.Center, Parent = wpRow })
    New("TextLabel", { Size = UDim2.new(0, 160, 1, 0), BackgroundTransparency = 1, Text = "Shop Waypoint", TextColor3 = Theme.Text, Font = Enum.Font.GothamBold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = wpRow })
    local wpBtn = Components.PillButton({ Parent = wpRow, Size = UDim2.new(0, 100, 0, 28), Text = "Set Here" })
    bind(wpBtn.MouseButton1Click:Connect(function()
        local hrp = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local pos = hrp.Position
            config.shopWaypoint = {X = pos.X, Y = pos.Y, Z = pos.Z}
            saveConfig()
            wpBtn.Text = "Saved!"
            task.wait(1)
            wpBtn.Text = "Set Here"
        end
    end))

    Components.SectionLabel("UI Scale", setCard, 150)
    local slF = New("Frame", { Size = UDim2.new(1, -24, 0, 64), Position = UDim2.new(0, 12, 0, 180), BackgroundColor3 = Color3.fromRGB(20,20,20), Parent = setCard, ZIndex = 2 }, { New("UICorner", { CornerRadius = UDim.new(0,10) }), New("UIStroke", { Color = Theme.Stroke, Thickness = 1 }) })
    local bar = New("Frame", { Size = UDim2.new(1, -24, 0, 8), Position = UDim2.new(0, 12, 0.5, -4), BackgroundColor3 = Color3.fromRGB(40,40,40), Parent = slF, ZIndex = 3, Active = true }, { New("UICorner", { CornerRadius = UDim.new(1, 0) }) })
    local fill = New("Frame", { Size = UDim2.new(0.5, 0, 1, 0), BackgroundColor3 = Theme.AccentA:lerp(Theme.AccentB,0.5), Parent = bar, ZIndex = 4 }, { New("UICorner", { CornerRadius = UDim.new(1, 0) }) })
    local knob = New("Frame", { Size = UDim2.new(0, 14, 0, 14), Position = UDim2.new(0.5, -7, 0.5, -7), BackgroundColor3 = Color3.fromRGB(240,240,240), Parent = bar, ZIndex = 5, Active = true }, { New("UICorner", { CornerRadius = UDim.new(1, 0) }), New("UIStroke", { Color = Theme.Stroke, Thickness = 1 }) })
    local valT = New("TextLabel", { Size = UDim2.new(1, -24, 0, 18), Position = UDim2.new(0, 12, 1, -24), BackgroundTransparency = 1, TextColor3 = Theme.Muted, Font = Enum.Font.Gotham, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Right, Text = math.floor(config.uiScale*100).."%", Parent = slF, ZIndex = 3 })
    local sc = New("UIScale", { Scale = config.uiScale, Parent = frame })
    local dSl = false
    local function setA(a) a = math.clamp(a, 0, 1); fill.Size = UDim2.new(a, 0, 1, 0); knob.Position = UDim2.new(a, -7, 0.5, -7); sc.Scale = 0.5 + a*1.5; config.uiScale = sc.Scale; saveConfig(); valT.Text = string.format("%d%%", math.floor(sc.Scale*100 + 0.5)) end
    setA((config.uiScale - 0.5) / 1.5)
    bind(bar.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dSl = true; setA((i.Position.X - bar.AbsolutePosition.X)/bar.AbsoluteSize.X) end end))
    bind(UserInputService.InputChanged:Connect(function(i) if dSl and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then setA((i.Position.X - bar.AbsolutePosition.X)/bar.AbsoluteSize.X) end end))
    bind(UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dSl = false end end))

    local vis, scA = true, Instance.new("UIScale", frame)
    local function toggle()
        vis = not vis; if vis then ensureOverlay(); FX.TweenBlur(true); mainGui.Enabled = true; scA.Scale = 1.06; TweenService:Create(scA, TweenInfo.new(0.2), {Scale=1}):Play() else closeAllDropdowns(); local tw = TweenService:Create(scA, TweenInfo.new(0.2), {Scale=1.06}); tw:Play(); tw.Completed:Wait(); if not unloaded then mainGui.Enabled = false; FX.TweenBlur(false) end end
    end
    bind(UserInputService.InputBegan:Connect(function(i, gp) if not gp and i.KeyCode == Enum.KeyCode.LeftAlt then toggle() end end))
    pcall(function() if failsafeGui then failsafeGui:Destroy() end end)
    return {}
end

local success, err = pcall(buildGui)
if not success then warn("Build Failed:", err) unload() return end
ensureOverlay()
